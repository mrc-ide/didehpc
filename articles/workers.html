<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workers • didehpc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Workers">
<meta property="og:description" content="didehpc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">didehpc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.16</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/didehpc.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/orderly.html">Using didehpc to run orderly tasks</a>
    </li>
    <li>
      <a href="../articles/packages.html">Package installation</a>
    </li>
    <li>
      <a href="../articles/quickstart.html">Quickstart for R and the DIDE cluster</a>
    </li>
    <li>
      <a href="../articles/troubleshooting.html">Troubleshooting</a>
    </li>
    <li>
      <a href="../articles/workers.html">Workers</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/didehpc/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="workers_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Workers</h1>
                        <h4 data-toc-skip class="author">Rich FitzJohn</h4>
            
            <h4 data-toc-skip class="date">2021-08-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/didehpc/blob/HEAD/vignettes/workers.Rmd" class="external-link"><code>vignettes/workers.Rmd</code></a></small>
      <div class="hidden name"><code>workers.Rmd</code></div>

    </div>

    
    
<!-- DO NOT EDIT THIS FILE - see vignettes_src and make changes there -->
<div class="section level2">
<h2 id="running-heaps-of-jobs-without-annoying-your-colleagues">Running heaps of jobs without annoying your colleagues<a class="anchor" aria-label="anchor" href="#running-heaps-of-jobs-without-annoying-your-colleagues"></a>
</h2>
<p>If you have thousands and thousands of jobs to submit at once you may not want to flood the cluster with them all at once. Each job submission is relatively slow (the HPC tools that the web interface has to use are relatively slow). The actual queue that the cluster uses doesn’t seem to like processing tens of thousands of job, and can slow down. And if you take up the whole cluster someone may come and knock on your office and complain at you. At the same time, batching your jobs up into little bits and manually sending them off is a pain and work better done by a computer.</p>
<p>An alternative is to submit a set of “workers” to the cluster, and then submit jobs to them. This is done with the <a href="https://github.com/mrc-ide/rrq" class="external-link"><code>rrq</code></a> package, along with a <a href="https://redis.io" class="external-link"><code>redis</code></a> server running on the cluster.</p>
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
</div>
<div class="section level3">
<h3 id="getting-started">Getting started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h3>
<p>To get started you will need to install the <code>rrq</code> package locally.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">drat</span><span class="fu">::</span><span class="fu">add</span><span class="op">(</span><span class="st">"mrc-ide"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"rrq"</span><span class="op">)</span></span></code></pre></div>
<p>Then construct the context as before</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">root</span> <span class="op">&lt;-</span> <span class="st">"contexts"</span></span>
<span><span class="va">ctx</span> <span class="op">&lt;-</span> <span class="fu">context</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/context/man/context_save.html" class="external-link">context_save</a></span><span class="op">(</span><span class="va">root</span>, sources <span class="op">=</span> <span class="st">"mysources.R"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [ open:db   ]  rds</span></span></code></pre></div>
<p>There are two ways we can proceed from here; the first - “workers” - is very similar to the non-worker workflow and is described first. The second - “rrq” - is a bit more involved and is described second.</p>
</div>
<div class="section level3">
<h3 id="workers">Workers<a class="anchor" aria-label="anchor" href="#workers"></a>
</h3>
<p>Then configure and create the queue; the <code>use_workers</code> argument is important here as it:</p>
<ul>
<li>ensures that the <code>rrq</code> package is available on the cluster, where your workers will run</li>
<li>changes the behaviour of the <code>$enqueue</code> method so that jobs are not sent to the HPC scheduler but to the <code>rrq</code> scheduler</li>
<li>enables the <code>$submit_workers</code> method which you will use to create workers on the cluster</li>
</ul>
<p>However, everything else will appear the same.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu">didehpc</span><span class="fu">::</span><span class="fu"><a href="../reference/didehpc_config.html">didehpc_config</a></span><span class="op">(</span>use_workers <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">didehpc</span><span class="fu">::</span><span class="fu"><a href="../reference/queue_didehpc.html">queue_didehpc</a></span><span class="op">(</span><span class="va">ctx</span>, config <span class="op">=</span> <span class="va">config</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading context 02a9261fe4e9e6554d76936ecb35cef0</span></span>
<span><span class="co">#&gt; [ context   ]  02a9261fe4e9e6554d76936ecb35cef0</span></span>
<span><span class="co">#&gt; [ library   ]</span></span>
<span><span class="co">#&gt; [ namespace ]</span></span>
<span><span class="co">#&gt; [ source    ]  mysources.R</span></span>
<span><span class="co">#&gt; Running installation script on cluster</span></span>
<span><span class="co">#&gt;   ,:\      /:.</span></span>
<span><span class="co">#&gt;  //  \_()_/  \\</span></span>
<span><span class="co">#&gt; ||   |    |   ||  CONAN THE LIBRARIAN</span></span>
<span><span class="co">#&gt; ||   |    |   ||  Library:   Q:\didehpc\20210817-145020\contexts\lib\windows\4.0</span></span>
<span><span class="co">#&gt; ||   |____|   ||  Bootstrap: T:\conan\bootstrap\4.0</span></span>
<span><span class="co">#&gt;  \\  / || \  //   Cache:     Q:\didehpc\20210817-145020\contexts\conan\cache/pkg</span></span>
<span><span class="co">#&gt;   `:/  ||  \;'    Policy:    lazy</span></span>
<span><span class="co">#&gt;        ||         Repos:</span></span>
<span><span class="co">#&gt;        ||           * https://mrc-ide.github.io/didehpc-pkgs</span></span>
<span><span class="co">#&gt;        XX           * https://cloud.r-project.org</span></span>
<span><span class="co">#&gt;        XX         Packages:</span></span>
<span><span class="co">#&gt;        XX           * rrq</span></span>
<span><span class="co">#&gt;        XX           * callr</span></span>
<span><span class="co">#&gt;        OO</span></span>
<span><span class="co">#&gt;        `'</span></span>
<span><span class="co">#&gt; i Loading metadata database</span></span>
<span><span class="co">#&gt; v Loading metadata database ... done</span></span>
<span><span class="co">#&gt; i Getting 8 pkgs (2.79 MB), 1 cached</span></span>
<span><span class="co">#&gt; v Got rrq 0.4.4 (source) (118.54 kB)</span></span>
<span><span class="co">#&gt; v Got prettyunits 1.1.1 (windows) (37.72 kB)</span></span>
<span><span class="co">#&gt; v Got progress 1.2.2 (windows) (85.86 kB)</span></span>
<span><span class="co">#&gt; v Got docopt 0.7.1 (windows) (245.69 kB)</span></span>
<span><span class="co">#&gt; v Got hms 1.1.0 (windows) (104.22 kB)</span></span>
<span><span class="co">#&gt; v Got redux 1.1.0 (windows) (287.97 kB)</span></span>
<span><span class="co">#&gt; v Got callr 3.7.0 (windows) (439.25 kB)</span></span>
<span><span class="co">#&gt; v Got processx 3.5.2 (windows) (1.25 MB)</span></span>
<span><span class="co">#&gt; v Got ps 1.6.0 (windows) (775.40 kB)</span></span>
<span><span class="co">#&gt; v Installed docopt 0.7.1  (719ms)</span></span>
<span><span class="co">#&gt; v Installed hms 1.1.0  (829ms)</span></span>
<span><span class="co">#&gt; v Installed progress 1.2.2  (907ms)</span></span>
<span><span class="co">#&gt; v Installed prettyunits 1.1.1  (1s)</span></span>
<span><span class="co">#&gt; v Installed callr 3.7.0  (1.1s)</span></span>
<span><span class="co">#&gt; v Installed redux 1.1.0  (1.3s)</span></span>
<span><span class="co">#&gt; i Building rrq 0.4.4</span></span>
<span><span class="co">#&gt; v Installed processx 3.5.2  (6.7s)</span></span>
<span><span class="co">#&gt; v Installed ps 1.6.0  (6.8s)</span></span>
<span><span class="co">#&gt; v Built rrq 0.4.4 (8s)</span></span>
<span><span class="co">#&gt; v Installed rrq 0.4.4  (438ms)</span></span>
<span><span class="co">#&gt; v Summary:   9 new   15 kept  in 27.8s</span></span>
<span><span class="co">#&gt; Done!</span></span></code></pre></div>
<p>You can now submit</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="fu">enqueue</span><span class="op">(</span><span class="fu">random_walk</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This job will stay pending forever as the HPC scheduler will never run it</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span><span class="op">$</span><span class="fu">status</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "PENDING"</span></span>
<span><span class="va">t</span><span class="op">$</span><span class="fu">times</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;                            task_id           submitted started finished</span></span>
<span><span class="co">#&gt; 1 cb4d883580667f393a2945a05688620a 2021-08-17 14:53:51    &lt;NA&gt;     &lt;NA&gt;</span></span>
<span><span class="co">#&gt;     waiting running idle</span></span>
<span><span class="co">#&gt; 1 0.2062078      NA   NA</span></span></code></pre></div>
<p>You must submit actual workers in order to actually run things. This could have been done before submitting the tasks, though workers will time out after 10 minutes of inactivity, if you have very many jobs to save your workers might exit before the work starts!</p>
<p>The argument is the number of workers to submit. Each worker is equivalent to a job that your configuration would otherwise create (in terms of cores selected).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">workers</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="fu">submit_workers</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Submitting 2 workers with base name 'epicurean_xiaosaurus'</span></span>
<span><span class="co">#&gt; submitting (-) [===================================] 100% | giving up in 600 s</span></span>
<span><span class="va">workers</span></span>
<span><span class="co">#&gt; [1] "epicurean_xiaosaurus_1" "epicurean_xiaosaurus_2"</span></span></code></pre></div>
<p>All workers get names in the form <code>&lt;adjective&gt;_&lt;animal&gt;_&lt;integer&gt;</code> so that you can remember which workers you set off. They will turn off after 10 minutes of inactivity by default (you can tweak this with the <code>worker_timeout</code> argument to <code>didehpc_config</code> or by sending a <code>TIMEOUT_SET</code> message).</p>
<p>One advantage over the usual queuing approach here is that you will not wait for anyone else’s jobs to complete once you have reserved your workers.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span><span class="op">$</span><span class="fu">wait</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; (-) waiting for cb4d883...20a, giving up in 9.5 s</span></span>
<span><span class="co">#&gt;  [1]  0.92566336 -0.58321241  0.54753392  0.72564391  0.51248705 -0.22445805</span></span>
<span><span class="co">#&gt;  [7]  0.03966805 -0.25494044 -0.16625861 -1.97337247</span></span></code></pre></div>
<p>We’re going to interact with the rrq object a bit</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rrq</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="fu">rrq_controller</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rrq</span></span>
<span><span class="co">#&gt; &lt;rrq_controller&gt;</span></span>
<span><span class="co">#&gt;   Public:</span></span>
<span><span class="co">#&gt;     bulk_wait: function (x, timeout = Inf, time_poll = 1, progress = NULL, delete = TRUE)</span></span>
<span><span class="co">#&gt;     con: redis_api, R6</span></span>
<span><span class="co">#&gt;     deferred_list: function ()</span></span>
<span><span class="co">#&gt;     destroy: function (delete = TRUE, worker_stop_type = "message", worker_stop_timeout = 0)</span></span>
<span><span class="co">#&gt;     enqueue: function (expr, envir = parent.frame(), queue = NULL, separate_process = FALSE,</span></span>
<span><span class="co">#&gt;     enqueue_: function (expr, envir = parent.frame(), queue = NULL, separate_process = FALSE,</span></span>
<span><span class="co">#&gt;     enqueue_bulk: function (x, fun, ..., dots = NULL, envir = parent.frame(), queue = NULL,</span></span>
<span><span class="co">#&gt;     enqueue_bulk_: function (x, fun, ..., dots = NULL, envir = parent.frame(), queue = NULL,</span></span>
<span><span class="co">#&gt;     envir: function (create, notify = TRUE)</span></span>
<span><span class="co">#&gt;     initialize: function (queue_id, con = redux::hiredis())</span></span>
<span><span class="co">#&gt;     keys: list</span></span>
<span><span class="co">#&gt;     lapply: function (x, fun, ..., dots = NULL, envir = parent.frame(), queue = NULL,</span></span>
<span><span class="co">#&gt;     lapply_: function (x, fun, ..., dots = NULL, envir = parent.frame(), queue = NULL,</span></span>
<span><span class="co">#&gt;     message_get_response: function (message_id, worker_ids = NULL, named = TRUE, delete = FALSE,</span></span>
<span><span class="co">#&gt;     message_has_response: function (message_id, worker_ids = NULL, named = TRUE)</span></span>
<span><span class="co">#&gt;     message_response_ids: function (worker_id)</span></span>
<span><span class="co">#&gt;     message_send: function (command, args = NULL, worker_ids = NULL)</span></span>
<span><span class="co">#&gt;     message_send_and_wait: function (command, args = NULL, worker_ids = NULL, named = TRUE,</span></span>
<span><span class="co">#&gt;     queue_id: 02a9261fe4e9e6554d76936ecb35cef0</span></span>
<span><span class="co">#&gt;     queue_length: function (queue = NULL)</span></span>
<span><span class="co">#&gt;     queue_list: function (queue = NULL)</span></span>
<span><span class="co">#&gt;     queue_remove: function (task_ids, queue = NULL)</span></span>
<span><span class="co">#&gt;     task_cancel: function (task_id, wait = TRUE, delete = TRUE)</span></span>
<span><span class="co">#&gt;     task_data: function (task_id)</span></span>
<span><span class="co">#&gt;     task_delete: function (task_ids, check = TRUE)</span></span>
<span><span class="co">#&gt;     task_exists: function (task_ids = NULL)</span></span>
<span><span class="co">#&gt;     task_list: function ()</span></span>
<span><span class="co">#&gt;     task_overview: function (task_ids = NULL)</span></span>
<span><span class="co">#&gt;     task_position: function (task_ids, missing = 0L, queue = NULL)</span></span>
<span><span class="co">#&gt;     task_preceeding: function (task_id, queue = NULL)</span></span>
<span><span class="co">#&gt;     task_progress: function (task_id)</span></span>
<span><span class="co">#&gt;     task_result: function (task_id)</span></span>
<span><span class="co">#&gt;     task_status: function (task_ids = NULL)</span></span>
<span><span class="co">#&gt;     task_wait: function (task_id, timeout = Inf, time_poll = 1, progress = NULL)</span></span>
<span><span class="co">#&gt;     tasks_result: function (task_ids)</span></span>
<span><span class="co">#&gt;     tasks_wait: function (task_ids, timeout = Inf, time_poll = 1, progress = NULL)</span></span>
<span><span class="co">#&gt;     worker_config_list: function ()</span></span>
<span><span class="co">#&gt;     worker_config_read: function (name)</span></span>
<span><span class="co">#&gt;     worker_config_save: function (name, time_poll = NULL, timeout = NULL, queue = NULL,</span></span>
<span><span class="co">#&gt;     worker_delete_exited: function (worker_ids = NULL)</span></span>
<span><span class="co">#&gt;     worker_detect_exited: function ()</span></span>
<span><span class="co">#&gt;     worker_info: function (worker_ids = NULL)</span></span>
<span><span class="co">#&gt;     worker_len: function ()</span></span>
<span><span class="co">#&gt;     worker_list: function ()</span></span>
<span><span class="co">#&gt;     worker_list_exited: function ()</span></span>
<span><span class="co">#&gt;     worker_load: function (worker_ids = NULL)</span></span>
<span><span class="co">#&gt;     worker_log_tail: function (worker_ids = NULL, n = 1)</span></span>
<span><span class="co">#&gt;     worker_process_log: function (worker_id)</span></span>
<span><span class="co">#&gt;     worker_status: function (worker_ids = NULL)</span></span>
<span><span class="co">#&gt;     worker_stop: function (worker_ids = NULL, type = "message", timeout = 0, time_poll = 0.05,</span></span>
<span><span class="co">#&gt;     worker_task_id: function (worker_ids = NULL)</span></span>
<span><span class="co">#&gt;   Private:</span></span>
<span><span class="co">#&gt;     scripts: list</span></span>
<span><span class="co">#&gt;     store: object_store, R6</span></span></code></pre></div>
<p>This is another R6 object, though this one at least has decent documentation - see the <code><a href="https://rdrr.io/pkg/rrq/man/rrq_controller.html" class="external-link">rrq::rrq_controller</a></code> for details of each method</p>
<p>You can see what your workers have been up to with the <code>workers_log_tail</code> command:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rrq</span><span class="op">$</span><span class="fu">worker_log_tail</span><span class="op">(</span>n <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="co">#&gt;                worker_id       time       command</span></span>
<span><span class="co">#&gt; 1 epicurean_xiaosaurus_1 1629208433         ALIVE</span></span>
<span><span class="co">#&gt; 2 epicurean_xiaosaurus_1 1629208433    TASK_START</span></span>
<span><span class="co">#&gt; 3 epicurean_xiaosaurus_2 1629208434         ALIVE</span></span>
<span><span class="co">#&gt; 4 epicurean_xiaosaurus_1 1629208434 TASK_COMPLETE</span></span>
<span><span class="co">#&gt;                            message</span></span>
<span><span class="co">#&gt; 1</span></span>
<span><span class="co">#&gt; 2 977ba6cb22c03767d8bb2386b0c2b271</span></span>
<span><span class="co">#&gt; 3</span></span>
<span><span class="co">#&gt; 4 977ba6cb22c03767d8bb2386b0c2b271</span></span></code></pre></div>
<p>The <code>time</code> column represents seconds - relative seconds should still be useful here.</p>
<p>As before, logging works on a per-task basis:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span><span class="op">$</span><span class="fu">log</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [ open:db   ]  rds</span></span>
<span><span class="co">#&gt; [ context   ]  02a9261fe4e9e6554d76936ecb35cef0</span></span>
<span><span class="co">#&gt; [ library   ]</span></span>
<span><span class="co">#&gt; [ namespace ]</span></span>
<span><span class="co">#&gt; [ source    ]  mysources.R</span></span>
<span><span class="co">#&gt; [ root      ]  contexts</span></span>
<span><span class="co">#&gt; [ context   ]  02a9261fe4e9e6554d76936ecb35cef0</span></span>
<span><span class="co">#&gt; [ task      ]  cb4d883580667f393a2945a05688620a</span></span>
<span><span class="co">#&gt; [ expr      ]  random_walk(0, 10)</span></span>
<span><span class="co">#&gt; [ start     ]  2021-08-17 14:53:54.075</span></span>
<span><span class="co">#&gt; [ ok        ]</span></span>
<span><span class="co">#&gt; [ end       ]  2021-08-17 14:53:54.231</span></span></code></pre></div>
<p>Find out how long your workers will persist for:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rrq</span><span class="op">$</span><span class="fu">message_send_and_wait</span><span class="op">(</span><span class="st">"TIMEOUT_GET"</span>, worker_ids <span class="op">=</span> <span class="va">workers</span><span class="op">)</span></span>
<span><span class="co">#&gt; $epicurean_xiaosaurus_1</span></span>
<span><span class="co">#&gt;   timeout remaining</span></span>
<span><span class="co">#&gt;       600       600</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; $epicurean_xiaosaurus_2</span></span>
<span><span class="co">#&gt;   timeout remaining</span></span>
<span><span class="co">#&gt;  600.0000  599.4219</span></span></code></pre></div>
<p>Other than that, hopefully everything else continues as normal. We can submit a bunch of jobs and run them using <code>$lapply</code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sizes</span> <span class="op">&lt;-</span> <span class="fl">3</span><span class="op">:</span><span class="fl">8</span></span>
<span><span class="va">grp</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="fu">lapply</span><span class="op">(</span><span class="va">sizes</span>, <span class="va">random_walk</span>, x <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; Creating bundle: 'robust_krill'</span></span>
<span><span class="co">#&gt; [ bulk      ]  Creating 6 tasks</span></span>
<span><span class="co">#&gt; submitting 6 tasks</span></span></code></pre></div>
<p>Task status:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grp</span><span class="op">$</span><span class="fu">status</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; e505c76477549a36f04625d810b494e1 8f2525389b6ba6ca19034567599a42be</span></span>
<span><span class="co">#&gt;                        "PENDING"                        "PENDING"</span></span>
<span><span class="co">#&gt; 579c132c388fb39f88992691a9ff16a1 bacdb4853335a3bc3ff9008d3bc09a93</span></span>
<span><span class="co">#&gt;                        "PENDING"                        "PENDING"</span></span>
<span><span class="co">#&gt; 5aa65c5b6b3b41b5afdf471a2e75886b 001a83fce62afb5eb9c49eda46d4c3cf</span></span>
<span><span class="co">#&gt;                        "PENDING"                        "PENDING"</span></span></code></pre></div>
<p>Collect the results:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">grp</span><span class="op">$</span><span class="fu">wait</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; (-) [=======================&gt;------------------------] 50% | giving up in 4 s</span></span>
<span><span class="co">#&gt; (\) [=======================&gt;------------------------] 50% | giving up in 4 s</span></span>
<span><span class="co">#&gt; (|) [================================================] 100% | giving up in 3 s</span></span>
<span><span class="va">res</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] -0.7841728 -1.9470967 -2.1056223</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] -0.4309173 -1.6581243 -0.4737780  0.4492074</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] -1.4924993 -2.0190762 -0.6046004 -1.3086768 -1.4110236</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; [1] -1.184490257 -0.196637540 -0.191229471 -0.004466775  0.483852828</span></span>
<span><span class="co">#&gt; [6]  1.066925267</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; [[5]]</span></span>
<span><span class="co">#&gt; [1]  0.6912883 -0.6199649 -1.4499917 -2.5812726 -1.4212357 -1.4081750 -2.2605613</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; [[6]]</span></span>
<span><span class="co">#&gt; [1] -0.54840267  0.05881601  0.71391542  1.40774062  1.85894605  3.56734897</span></span>
<span><span class="co">#&gt; [7]  4.74281970  5.10295235</span></span></code></pre></div>
<p>While workers will turn off automatically, it’s polite to turn them off as soon as you’re done using <code>obj$stop_workers()</code></p>
<p>Alternatively, after submitting a bunch of jobs you can run</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rrq</span><span class="op">$</span><span class="fu">message_send</span><span class="op">(</span><span class="st">"TIMEOUT_SET"</span>, <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>which will mean that the workers will stop immediately after not receiving a task (so after they finish processing all your jobs they’ll stop one by one). Practically this still takes one minute because that’s the polling timeout time (I may be able to improve this later).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj</span><span class="op">$</span><span class="fu">stop_workers</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">rrq</span><span class="op">$</span><span class="fu">worker_log_tail</span><span class="op">(</span><span class="va">workers</span>, n <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 worker_id       time       command</span></span>
<span><span class="co">#&gt; 1  epicurean_xiaosaurus_1 1629208433         ALIVE</span></span>
<span><span class="co">#&gt; 2  epicurean_xiaosaurus_1 1629208433    TASK_START</span></span>
<span><span class="co">#&gt; 3  epicurean_xiaosaurus_2 1629208434         ALIVE</span></span>
<span><span class="co">#&gt; 4  epicurean_xiaosaurus_1 1629208434 TASK_COMPLETE</span></span>
<span><span class="co">#&gt; 5  epicurean_xiaosaurus_1 1629208435       MESSAGE</span></span>
<span><span class="co">#&gt; 6  epicurean_xiaosaurus_1 1629208435      RESPONSE</span></span>
<span><span class="co">#&gt; 7  epicurean_xiaosaurus_2 1629208435       MESSAGE</span></span>
<span><span class="co">#&gt; 8  epicurean_xiaosaurus_2 1629208435      RESPONSE</span></span>
<span><span class="co">#&gt; 9  epicurean_xiaosaurus_1 1629208435    TASK_START</span></span>
<span><span class="co">#&gt; 10 epicurean_xiaosaurus_2 1629208435    TASK_START</span></span>
<span><span class="co">#&gt; 11 epicurean_xiaosaurus_1 1629208436 TASK_COMPLETE</span></span>
<span><span class="co">#&gt; 12 epicurean_xiaosaurus_1 1629208436    TASK_START</span></span>
<span><span class="co">#&gt; 13 epicurean_xiaosaurus_2 1629208436 TASK_COMPLETE</span></span>
<span><span class="co">#&gt; 14 epicurean_xiaosaurus_2 1629208436    TASK_START</span></span>
<span><span class="co">#&gt; 15 epicurean_xiaosaurus_1 1629208436 TASK_COMPLETE</span></span>
<span><span class="co">#&gt; 16 epicurean_xiaosaurus_1 1629208436    TASK_START</span></span>
<span><span class="co">#&gt; 17 epicurean_xiaosaurus_2 1629208436 TASK_COMPLETE</span></span>
<span><span class="co">#&gt; 18 epicurean_xiaosaurus_2 1629208436    TASK_START</span></span>
<span><span class="co">#&gt; 19 epicurean_xiaosaurus_1 1629208437 TASK_COMPLETE</span></span>
<span><span class="co">#&gt; 20 epicurean_xiaosaurus_2 1629208437 TASK_COMPLETE</span></span>
<span><span class="co">#&gt; 21 epicurean_xiaosaurus_1 1629208437       MESSAGE</span></span>
<span><span class="co">#&gt; 22 epicurean_xiaosaurus_1 1629208437      RESPONSE</span></span>
<span><span class="co">#&gt; 23 epicurean_xiaosaurus_1 1629208437          STOP</span></span>
<span><span class="co">#&gt; 24 epicurean_xiaosaurus_2 1629208437       MESSAGE</span></span>
<span><span class="co">#&gt; 25 epicurean_xiaosaurus_2 1629208437      RESPONSE</span></span>
<span><span class="co">#&gt; 26 epicurean_xiaosaurus_2 1629208437          STOP</span></span>
<span><span class="co">#&gt;                             message</span></span>
<span><span class="co">#&gt; 1</span></span>
<span><span class="co">#&gt; 2  977ba6cb22c03767d8bb2386b0c2b271</span></span>
<span><span class="co">#&gt; 3</span></span>
<span><span class="co">#&gt; 4  977ba6cb22c03767d8bb2386b0c2b271</span></span>
<span><span class="co">#&gt; 5                       TIMEOUT_GET</span></span>
<span><span class="co">#&gt; 6                       TIMEOUT_GET</span></span>
<span><span class="co">#&gt; 7                       TIMEOUT_GET</span></span>
<span><span class="co">#&gt; 8                       TIMEOUT_GET</span></span>
<span><span class="co">#&gt; 9  96b4a731efe9bf2efb5e3e7e6aef781a</span></span>
<span><span class="co">#&gt; 10 1df4287014a01c65f807c39cc84e5482</span></span>
<span><span class="co">#&gt; 11 96b4a731efe9bf2efb5e3e7e6aef781a</span></span>
<span><span class="co">#&gt; 12 26c86df13bf2c438bd3d09db57a3627a</span></span>
<span><span class="co">#&gt; 13 1df4287014a01c65f807c39cc84e5482</span></span>
<span><span class="co">#&gt; 14 7cbb27b699ffc184723d884e896a1c30</span></span>
<span><span class="co">#&gt; 15 26c86df13bf2c438bd3d09db57a3627a</span></span>
<span><span class="co">#&gt; 16 e544f4fafc61746df4b5d6b80b95338d</span></span>
<span><span class="co">#&gt; 17 7cbb27b699ffc184723d884e896a1c30</span></span>
<span><span class="co">#&gt; 18 b03fa5fd3f1509e6e98e9707cce0d445</span></span>
<span><span class="co">#&gt; 19 e544f4fafc61746df4b5d6b80b95338d</span></span>
<span><span class="co">#&gt; 20 b03fa5fd3f1509e6e98e9707cce0d445</span></span>
<span><span class="co">#&gt; 21                             STOP</span></span>
<span><span class="co">#&gt; 22                             STOP</span></span>
<span><span class="co">#&gt; 23                         OK (BYE)</span></span>
<span><span class="co">#&gt; 24                             STOP</span></span>
<span><span class="co">#&gt; 25                             STOP</span></span>
<span><span class="co">#&gt; 26                         OK (BYE)</span></span>
<span><span class="va">rrq</span><span class="op">$</span><span class="fu">destroy</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="rrq">rrq<a class="anchor" aria-label="anchor" href="#rrq"></a>
</h3>
<p>In this model, we create a very lightweight queue which in turn creates very lightweight tasks. This avoids even more overhead than the approach above, though it can be more difficult to debug because less information is saved. Rather than round-tripping data through the disk, everything goes via the redis server.</p>
<p>The first part here looks very similar, except that we use <code>use_rrq = TRUE</code> rather than <code>use_workers</code></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu">didehpc</span><span class="fu">::</span><span class="fu"><a href="../reference/didehpc_config.html">didehpc_config</a></span><span class="op">(</span>use_rrq <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">didehpc</span><span class="fu">::</span><span class="fu"><a href="../reference/queue_didehpc.html">queue_didehpc</a></span><span class="op">(</span><span class="va">ctx</span>, config <span class="op">=</span> <span class="va">config</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading context 02a9261fe4e9e6554d76936ecb35cef0</span></span>
<span><span class="co">#&gt; [ context   ]  02a9261fe4e9e6554d76936ecb35cef0</span></span>
<span><span class="co">#&gt; [ library   ]</span></span>
<span><span class="co">#&gt; [ namespace ]</span></span>
<span><span class="co">#&gt; [ source    ]  mysources.R</span></span></code></pre></div>
<p>We still submit workers</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">workers</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="fu">submit_workers</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; Submitting 10 workers with base name 'vegetarian_alaskajingle'</span></span>
<span><span class="co">#&gt; submitting (-) [======&gt;----------------------------] 20% | giving up in 599 s</span></span>
<span><span class="co">#&gt; submitting (\) [=========&gt;-------------------------] 30% | giving up in 599 s</span></span>
<span><span class="co">#&gt; submitting (|) [=============&gt;---------------------] 40% | giving up in 598 s</span></span>
<span><span class="co">#&gt; submitting (/) [=================&gt;-----------------] 50% | giving up in 597 s</span></span>
<span><span class="co">#&gt; submitting (-) [====================&gt;--------------] 60% | giving up in 597 s</span></span>
<span><span class="co">#&gt; submitting (\) [=======================&gt;-----------] 70% | giving up in 596 s</span></span>
<span><span class="co">#&gt; submitting (|) [===========================&gt;-------] 80% | giving up in 596 s</span></span>
<span><span class="co">#&gt; submitting (/) [===============================&gt;---] 90% | giving up in 596 s</span></span>
<span><span class="co">#&gt; submitting (-) [===================================] 100% | giving up in 595 s</span></span>
<span><span class="va">workers</span></span>
<span><span class="co">#&gt;  [1] "vegetarian_alaskajingle_1"  "vegetarian_alaskajingle_2"</span></span>
<span><span class="co">#&gt;  [3] "vegetarian_alaskajingle_3"  "vegetarian_alaskajingle_4"</span></span>
<span><span class="co">#&gt;  [5] "vegetarian_alaskajingle_5"  "vegetarian_alaskajingle_6"</span></span>
<span><span class="co">#&gt;  [7] "vegetarian_alaskajingle_7"  "vegetarian_alaskajingle_8"</span></span>
<span><span class="co">#&gt;  [9] "vegetarian_alaskajingle_9"  "vegetarian_alaskajingle_10"</span></span></code></pre></div>
<p>To send tasks to these workers we directly use the <code>rrq_controller</code> object - we’ll not use the <code>queue_didehpc</code> object from this point.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rrq</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="fu">rrq_controller</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This will look and act a lot like the main didehpc queue controller, but with a few differences. Tasks will come back as plain strings rather than user-friendly objects and <code>lapply</code> and <code>enqueue_bulk</code> are now blocking operations by default. Most tasks will clean up after they delete rather than leaving a persistent record on disk. The payback for this is potentially very fast task turnarounds and better behaviour with the disk under heavy load.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="va">rrq</span><span class="op">$</span><span class="fu">enqueue</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rrq</span><span class="op">$</span><span class="fu">task_wait</span><span class="op">(</span><span class="va">t</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.841471</span></span></code></pre></div>
<p>For example; submitting 50 trivial tasks to our pool of workers and retrieving the results:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">rrq</span><span class="op">$</span><span class="fu">lapply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span>, <span class="va">sin</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed</span></span>
<span><span class="co">#&gt;   0.026   0.000   0.325</span></span></code></pre></div>
<p>or 500 tasks:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">rrq</span><span class="op">$</span><span class="fu">lapply</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">500</span>, <span class="va">sin</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed</span></span>
<span><span class="co">#&gt;   0.161   0.052   1.476</span></span></code></pre></div>
<p>Across the network, the latency here is ~1/600 s per task. On fi–didemrchnb it will hopefully be a bit faster because of the infiniband network.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rrq</span><span class="op">$</span><span class="fu">worker_stop</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rrq</span><span class="op">$</span><span class="fu">destroy</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>It is theoretically possible to submit a cluster job that creates an <code>rrq_controller</code> and controls the second queue. To do that you need to write function like:</p>
<pre><code>get_rrq_controller &lt;- function(x, ...) {
  queue_id &lt;- Sys.getenv("CONTEXT_ID", "")
  stopifnot(queue_id != "")
  rrq::rrq_controller$new((queue_id)
}</code></pre>
<p>within your sources, then you can use it in place of running (say) a <code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply()</a></code> call in your code. This approach allows a relatively simple form of inter-process communication. Talk to Rich if this is something you might have a use for, if you have simulation needs that are larger than a single node.</p>
</div>
<div class="section level3">
<h3 id="advanced-use-different-worker-and-task-resources">Advanced use: different worker and task resources<a class="anchor" aria-label="anchor" href="#advanced-use-different-worker-and-task-resources"></a>
</h3>
<p>Suppose that we want to submit a job where we have a single process which orchestrates a group of workers each of which takes up an entire node. We used this pattern in the covid response where we wanted to run different MCMC chains on different nodes, each using 32 cores, but we also needed a single “controlling” process to organise collecting results from these nodes.</p>
<p>What we want to do do is specify a different set of resources to be used by the workers than by tasks submitted by <code>$enqueue()</code>. Note that this only makes sense when using <code>use_rrq = TRUE</code>. For example, to submit a controlling process that uses the <code>GeneralNodes</code> template and one core (the default) but worker processes that can use 8 cores, we might write</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu">didehpc</span><span class="fu">::</span><span class="fu"><a href="../reference/didehpc_config.html">didehpc_config</a></span><span class="op">(</span></span>
<span>  use_rrq <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  worker_resource <span class="op">=</span> <span class="fu">didehpc</span><span class="fu">::</span><span class="fu"><a href="../reference/worker_resource.html">worker_resource</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">config</span></span>
<span><span class="co">#&gt; &lt;didehpc_config&gt;</span></span>
<span><span class="co">#&gt;  - cluster: fi--dideclusthn</span></span>
<span><span class="co">#&gt;  - credentials:</span></span>
<span><span class="co">#&gt;     - username: rfitzjoh</span></span>
<span><span class="co">#&gt;     - password: *******************</span></span>
<span><span class="co">#&gt;  - username: rfitzjoh</span></span>
<span><span class="co">#&gt;  - resource:</span></span>
<span><span class="co">#&gt;     - template: GeneralNodes</span></span>
<span><span class="co">#&gt;     - parallel: FALSE</span></span>
<span><span class="co">#&gt;     - count: 1</span></span>
<span><span class="co">#&gt;     - type: Cores</span></span>
<span><span class="co">#&gt;  - shares:</span></span>
<span><span class="co">#&gt;     - home: (local) /home/rich/net/home =&gt; \\fi--san03.dide.ic.ac.uk\homes\rfitzjoh =&gt; Q: (remote)</span></span>
<span><span class="co">#&gt;     - temp: (local) /home/rich/net/temp =&gt; \\fi--didef3.dide.ic.ac.uk\tmp =&gt; T: (remote)</span></span>
<span><span class="co">#&gt;  - use_workers: FALSE</span></span>
<span><span class="co">#&gt;  - use_rrq: TRUE</span></span>
<span><span class="co">#&gt;  - worker_timeout: 600</span></span>
<span><span class="co">#&gt;  - conan_bootstrap: TRUE</span></span>
<span><span class="co">#&gt;  - r_version: 4.0.3</span></span>
<span><span class="co">#&gt;  - use_java: FALSE</span></span>
<span><span class="co">#&gt;  - redis_host: fi--dideclusthn.dide.ic.ac.uk</span></span>
<span><span class="co">#&gt;  - worker_resource:</span></span>
<span><span class="co">#&gt;     - template: GeneralNodes</span></span>
<span><span class="co">#&gt;     - parallel: TRUE</span></span>
<span><span class="co">#&gt;     - count: 8</span></span>
<span><span class="co">#&gt;     - type: Cores</span></span></code></pre></div>
<p>See the <code>worker_resource</code> section here indicates different resources to the <code>resource</code> section.</p>
<p>Now, when submitting workers with <code>obj$submit_workers</code> each worker will be able to use 8 cores, but a task submitted by <code>$enqueue()</code> will only be able to use one. You might then submit a task that uses the <code>get_rrq_controller</code> trick above as part of your single core job, which can then farm out work to your workers using the <code>rrq</code> queue object.</p>
</div>
<div class="section level3">
<h3 id="cleaning-up">Cleaning up<a class="anchor" aria-label="anchor" href="#cleaning-up"></a>
</h3>
<p>Above we use <code>rrq$destroy()</code> to clean up every trace of the queue. Periodically we may flush the entire Redis database, or set all keys to expire after a day or so. Do not leave any important information in here please.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rich FitzJohn, Wes Hinsley.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
