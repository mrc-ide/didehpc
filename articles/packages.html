<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Package installation • didehpc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Package installation">
<meta property="og:description" content="didehpc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">didehpc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/didehpc.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/packages.html">Package installation</a>
    </li>
    <li>
      <a href="../articles/quickstart.html">Quickstart for R and the DIDE cluster</a>
    </li>
    <li>
      <a href="../articles/troubleshooting.html">Troubleshooting</a>
    </li>
    <li>
      <a href="../articles/workers.html">Workers</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/didehpc/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="packages_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Package installation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/didehpc/blob/master/vignettes/packages.Rmd"><code>vignettes/packages.Rmd</code></a></small>
      <div class="hidden name"><code>packages.Rmd</code></div>

    </div>

    
    
<!-- DO NOT EDIT THIS FILE - see vignettes_src and make changes there -->
<p>Often the most difficult part of configuring your cluster jobs is sorting out all the packages that you need and making sure that they are present on the cluster. There are several levels of difficulty here and this document will walk through them in turn.</p>
<div id="everything-is-on-cran" class="section level2">
<h2 class="hasAnchor">
<a href="#everything-is-on-cran" class="anchor"></a>Everything is on CRAN</h2>
<p>This is the most straightforward situation - all your packages are on CRAN. You don’t need to do anything special typically, just create your context with a list of packages and create the queue:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">root</span> <span class="op">&lt;-</span> <span class="st">"pkgs"</span>
<span class="va">ctx</span> <span class="op">&lt;-</span> <span class="fu">context</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/context/man/context_save.html">context_save</a></span><span class="op">(</span><span class="va">root</span>, packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"ggplot2"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [ init:id   ]  56d34997c3c968cfaa337d18c74c552c</span>
<span class="co">#&gt; [ init:db   ]  rds</span>
<span class="co">#&gt; [ init:path ]  pkgs</span>
<span class="co">#&gt; [ save:id   ]  38f5f51a1f561e2d730e50b7268301a4</span>
<span class="co">#&gt; [ save:name ]  unexistential_billygoat</span>
<span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">didehpc</span><span class="fu">::</span><span class="fu"><a href="../reference/queue_didehpc.html">queue_didehpc</a></span><span class="op">(</span><span class="va">ctx</span><span class="op">)</span>
<span class="co">#&gt; Loading context 38f5f51a1f561e2d730e50b7268301a4</span>
<span class="co">#&gt; [ context   ]  38f5f51a1f561e2d730e50b7268301a4</span>
<span class="co">#&gt; [ library   ]  dplyr, ggplot2</span>
<span class="co">#&gt;</span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt;</span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt;</span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="co">#&gt; [ namespace ]</span>
<span class="co">#&gt; [ source    ]</span>
<span class="co">#&gt; Running installation script on cluster</span>
<span class="co">#&gt;   ,:\      /:.</span>
<span class="co">#&gt;  //  \_()_/  \\</span>
<span class="co">#&gt; ||   |    |   ||  CONAN THE LIBRARIAN</span>
<span class="co">#&gt; ||   |    |   ||  Library:   Q:\didehpc\20210420-102851\pkgs\lib\windows\4.0</span>
<span class="co">#&gt; ||   |____|   ||  Bootstrap: T:\conan\bootstrap\4.0</span>
<span class="co">#&gt;  \\  / || \  //   Cache:     Q:\didehpc\20210420-102851\pkgs\conan\cache/pkg</span>
<span class="co">#&gt;   `:/  ||  \;'    Policy:    lazy</span>
<span class="co">#&gt;        ||         Repos:</span>
<span class="co">#&gt;        ||           * https://mrc-ide.github.io/didehpc-pkgs</span>
<span class="co">#&gt;        XX           * https://cloud.r-project.org</span>
<span class="co">#&gt;        XX         Packages:</span>
<span class="co">#&gt;        XX           * context</span>
<span class="co">#&gt;        XX           * dplyr</span>
<span class="co">#&gt;        OO           * ggplot2</span>
<span class="co">#&gt;        `'</span>
<span class="co">#&gt; i Loading metadata database</span>
<span class="co">#&gt; v Loading metadata database ... done</span>
<span class="co">#&gt; i Getting 36 pkgs (27.70 MB) and 1 pkg with unknown size</span>
<span class="co">#&gt; v Got askpass 1.1 (windows) (243.57 kB)</span>
<span class="co">#&gt; v Got crayon 1.4.1 (windows) (141.72 kB)</span>
<span class="co">#&gt; v Got R6 2.5.0 (windows) (84.10 kB)</span>
<span class="co">#&gt; v Got digest 0.6.27 (windows) (268.60 kB)</span>
<span class="co">#&gt; v Got context 0.3.0 (source) (37.72 kB)</span>
<span class="co">#&gt; v Got ids 1.0.1 (windows) (123.91 kB)</span>
<span class="co">#&gt; v Got sys 3.4 (windows) (59.68 kB)</span>
<span class="co">#&gt; v Got uuid 0.1-4 (windows) (33.77 kB)</span>
<span class="co">#&gt; v Got ellipsis 0.3.1 (windows) (46.15 kB)</span>
<span class="co">#&gt; v Got generics 0.1.0 (windows) (70.84 kB)</span>
<span class="co">#&gt; v Got lifecycle 1.0.0 (windows) (111.22 kB)</span>
<span class="co">#&gt; v Got openssl 1.4.3 (windows) (3.99 MB)</span>
<span class="co">#&gt; v Got glue 1.4.2 (windows) (155.42 kB)</span>
<span class="co">#&gt; v Got cli 2.4.0 (windows) (504.14 kB)</span>
<span class="co">#&gt; v Got pkgconfig 2.0.3 (windows) (22.08 kB)</span>
<span class="co">#&gt; v Got magrittr 2.0.1 (windows) (235.68 kB)</span>
<span class="co">#&gt; v Got storr 1.2.5 (windows) (401.10 kB)</span>
<span class="co">#&gt; v Got dplyr 1.0.5 (windows) (1.33 MB)</span>
<span class="co">#&gt; v Got tibble 3.1.0 (windows) (825.59 kB)</span>
<span class="co">#&gt; v Got tidyselect 1.1.0 (windows) (203.17 kB)</span>
<span class="co">#&gt; v Got utf8 1.2.1 (windows) (209.84 kB)</span>
<span class="co">#&gt; v Got RColorBrewer 1.1-2 (windows) (55.55 kB)</span>
<span class="co">#&gt; v Got purrr 0.3.4 (windows) (426.90 kB)</span>
<span class="co">#&gt; v Got rlang 0.4.10 (windows) (1.20 MB)</span>
<span class="co">#&gt; v Got pillar 1.6.0 (windows) (1.02 MB)</span>
<span class="co">#&gt; v Got ggplot2 3.3.3 (windows) (4.07 MB)</span>
<span class="co">#&gt; v Got labeling 0.4.2 (windows) (62.73 kB)</span>
<span class="co">#&gt; v Got gtable 0.3.0 (windows) (434.20 kB)</span>
<span class="co">#&gt; v Got farver 2.1.0 (windows) (1.75 MB)</span>
<span class="co">#&gt; v Got vctrs 0.3.7 (windows) (1.25 MB)</span>
<span class="co">#&gt; v Got munsell 0.5.0 (windows) (244.85 kB)</span>
<span class="co">#&gt; v Got scales 1.1.1 (windows) (557.57 kB)</span>
<span class="co">#&gt; v Got withr 2.4.1 (windows) (209.25 kB)</span>
<span class="co">#&gt; v Got fansi 0.4.2 (windows) (224.19 kB)</span>
<span class="co">#&gt; v Got isoband 0.2.4 (windows) (3.06 MB)</span>
<span class="co">#&gt; v Got colorspace 2.0-0 (windows) (2.65 MB)</span>
<span class="co">#&gt; v Got viridisLite 0.4.0 (windows) (1.30 MB)</span>
<span class="co">#&gt; v Installed crayon 1.4.1  (969ms)</span>
<span class="co">#&gt; v Installed askpass 1.1  (1.3s)</span>
<span class="co">#&gt; v Installed R6 2.5.0  (2s)</span>
<span class="co">#&gt; v Installed ids 1.0.1  (1.7s)</span>
<span class="co">#&gt; v Installed sys 3.4  (1.8s)</span>
<span class="co">#&gt; v Installed storr 1.2.5  (2.2s)</span>
<span class="co">#&gt; v Installed digest 0.6.27  (2.6s)</span>
<span class="co">#&gt; v Installed openssl 1.4.3  (2.9s)</span>
<span class="co">#&gt; v Installed uuid 0.1-4  (2.2s)</span>
<span class="co">#&gt; i Building context 0.3.0</span>
<span class="co">#&gt; v Installed cli 2.4.0  (9.3s)</span>
<span class="co">#&gt; v Installed dplyr 1.0.5  (9.4s)</span>
<span class="co">#&gt; v Installed ellipsis 0.3.1  (9.4s)</span>
<span class="co">#&gt; v Installed fansi 0.4.2  (9.4s)</span>
<span class="co">#&gt; v Installed generics 0.1.0  (9.4s)</span>
<span class="co">#&gt; v Installed glue 1.4.2  (9.2s)</span>
<span class="co">#&gt; v Installed lifecycle 1.0.0  (9.1s)</span>
<span class="co">#&gt; v Installed pkgconfig 2.0.3  (1.4s)</span>
<span class="co">#&gt; v Installed magrittr 2.0.1  (2.2s)</span>
<span class="co">#&gt; v Installed purrr 0.3.4  (2.5s)</span>
<span class="co">#&gt; v Installed rlang 0.4.10  (2.6s)</span>
<span class="co">#&gt; v Installed pillar 1.6.0  (3.2s)</span>
<span class="co">#&gt; v Built context 0.3.0 (5.7s)</span>
<span class="co">#&gt; v Installed tibble 3.1.0  (2.9s)</span>
<span class="co">#&gt; v Installed tidyselect 1.1.0  (2.3s)</span>
<span class="co">#&gt; v Installed utf8 1.2.1  (2.4s)</span>
<span class="co">#&gt; v Installed vctrs 0.3.7  (1.9s)</span>
<span class="co">#&gt; v Installed RColorBrewer 1.1-2  (1.6s)</span>
<span class="co">#&gt; v Installed farver 2.1.0  (1.4s)</span>
<span class="co">#&gt; v Installed context 0.3.0  (1.6s)</span>
<span class="co">#&gt; v Installed gtable 0.3.0  (922ms)</span>
<span class="co">#&gt; v Installed labeling 0.4.2  (938ms)</span>
<span class="co">#&gt; v Installed ggplot2 3.3.3  (1.8s)</span>
<span class="co">#&gt; v Installed munsell 0.5.0  (1.3s)</span>
<span class="co">#&gt; v Installed colorspace 2.0-0  (3.7s)</span>
<span class="co">#&gt; v Installed scales 1.1.1  (1.6s)</span>
<span class="co">#&gt; v Installed isoband 0.2.4  (2.2s)</span>
<span class="co">#&gt; v Installed withr 2.4.1  (1.3s)</span>
<span class="co">#&gt; v Installed viridisLite 0.4.0  (1.5s)</span>
<span class="co">#&gt; v Summary:   37 new   5 kept  in 2m 9.9s</span>
<span class="co">#&gt; Done!</span></code></pre></div>
<p>What happened above was when the queue started up it looked to see what packages were available (none were) and then installed everything needed to run your jobs. That includes the two packages listed above but also all their dependencies and <a href="https://mrc-ide.github.io/context/"><code>context</code></a> which <code>didehpc</code> uses to send the jobs back and forth.</p>
<p>All these packages are installed into a special directory within the context root:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">root</span>, <span class="st">"lib/windows"</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric_version.html">getRversion</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;  [1] "R6"           "RColorBrewer" "_cache"       "askpass"      "cli"</span>
<span class="co">#&gt;  [6] "colorspace"   "context"      "crayon"       "digest"       "dplyr"</span>
<span class="co">#&gt; [11] "ellipsis"     "fansi"        "farver"       "generics"     "ggplot2"</span>
<span class="co">#&gt; [16] "glue"         "gtable"       "ids"          "isoband"      "labeling"</span>
<span class="co">#&gt; [21] "lifecycle"    "magrittr"     "munsell"      "openssl"      "pillar"</span>
<span class="co">#&gt; [26] "pkgconfig"    "purrr"        "rlang"        "scales"       "storr"</span>
<span class="co">#&gt; [31] "sys"          "tibble"       "tidyselect"   "utf8"         "uuid"</span>
<span class="co">#&gt; [36] "vctrs"        "viridisLite"  "withr"</span></code></pre></div>
<p>Everything in this library will be available to your R jobs when they run.</p>
</div>
<div id="everything-is-available-in-a-cran-like-repo" class="section level2">
<h2 class="hasAnchor">
<a href="#everything-is-available-in-a-cran-like-repo" class="anchor"></a>Everything is available in a CRAN-like repo</h2>
<p>We keep many often-used packages in a semi-stable repository (see the <a href="https://mrc-ide.github.io/drat/">mrc-ide drat</a>, the <a href="https://ncov-ic.github.io/drat/">ncov drat</a> and the more experimental <a href="https://mrc-ide.r-universe.dev/ui#builds">R-universe</a> system that is being developed to support this sort of workflow in future).</p>
<p>To tell <code>didehpc</code> to look in one of these repositories when installing, create a <code>conan::conan_sourcs</code> object and list additional repositories as the <code>repos</code> argument, and pass this object in as the <code>package_sources</code> argument to <code>context_save</code>. Here, we add the mrc-ide drat repository and install the <code>dde</code> package; this will use the development version which is often ahead of the CRAN version.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">src</span> <span class="op">&lt;-</span> <span class="fu">conan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/conan/man/conan_sources.html">conan_sources</a></span><span class="op">(</span><span class="cn">NULL</span>, repos <span class="op">=</span> <span class="st">"https://mrc-ide.github.io/drat/"</span><span class="op">)</span>
<span class="va">ctx</span> <span class="op">&lt;-</span> <span class="fu">context</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/context/man/context_save.html">context_save</a></span><span class="op">(</span><span class="va">root</span>, packages <span class="op">=</span> <span class="st">"dde"</span>, package_sources <span class="op">=</span> <span class="va">src</span><span class="op">)</span>
<span class="co">#&gt; [ open:db   ]  rds</span>
<span class="co">#&gt; [ save:id   ]  4dec7a1d5434eb725305ad4e3da5cbc1</span>
<span class="co">#&gt; [ save:name ]  unfair_whoopingcrane</span></code></pre></div>
<p>Create the library as before, and <code>dde</code> will be installed</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">didehpc</span><span class="fu">::</span><span class="fu"><a href="../reference/queue_didehpc.html">queue_didehpc</a></span><span class="op">(</span><span class="va">ctx</span><span class="op">)</span>
<span class="co">#&gt; Loading context 4dec7a1d5434eb725305ad4e3da5cbc1</span>
<span class="co">#&gt; [ context   ]  4dec7a1d5434eb725305ad4e3da5cbc1</span>
<span class="co">#&gt; [ library   ]  dde</span>
<span class="co">#&gt; [ namespace ]</span>
<span class="co">#&gt; [ source    ]</span>
<span class="co">#&gt; Running installation script on cluster</span>
<span class="co">#&gt;   ,:\      /:.</span>
<span class="co">#&gt;  //  \_()_/  \\</span>
<span class="co">#&gt; ||   |    |   ||  CONAN THE LIBRARIAN</span>
<span class="co">#&gt; ||   |    |   ||  Library:   Q:\didehpc\20210420-102851\pkgs\lib\windows\4.0</span>
<span class="co">#&gt; ||   |____|   ||  Bootstrap: T:\conan\bootstrap\4.0</span>
<span class="co">#&gt;  \\  / || \  //   Cache:     Q:\didehpc\20210420-102851\pkgs\conan\cache/pkg</span>
<span class="co">#&gt;   `:/  ||  \;'    Policy:    lazy</span>
<span class="co">#&gt;        ||         Repos:</span>
<span class="co">#&gt;        ||           * https://mrc-ide.github.io/drat/</span>
<span class="co">#&gt;        XX           * https://cloud.r-project.org</span>
<span class="co">#&gt;        XX           * https://mrc-ide.github.io/didehpc-pkgs</span>
<span class="co">#&gt;        XX         Packages:</span>
<span class="co">#&gt;        XX           * context</span>
<span class="co">#&gt;        OO           * dde</span>
<span class="co">#&gt;        `'</span>
<span class="co">#&gt;</span>
<span class="co">#&gt; v Updated metadata database: 5.45 kB in 2 files.</span>
<span class="co">#&gt;</span>
<span class="co">#&gt; i Updating metadata database</span>
<span class="co">#&gt; v Updating metadata database ... done</span>
<span class="co">#&gt; i Getting 1 pkg (481.50 kB), 1 cached</span>
<span class="co">#&gt; v Got dde 1.0.3 (source) (180.79 kB)</span>
<span class="co">#&gt; v Got ring 1.0.0 (windows) (479.48 kB)</span>
<span class="co">#&gt; v Installed ring 1.0.0  (641ms)</span>
<span class="co">#&gt; i Building dde 1.0.3</span>
<span class="co">#&gt; v Built dde 1.0.3 (36.1s)</span>
<span class="co">#&gt; v Installed dde 1.0.3  (516ms)</span>
<span class="co">#&gt; v Summary:   2 new   10 kept  in 37.2s</span>
<span class="co">#&gt; Done!</span></code></pre></div>
<p>If you want to add your packages to one of these repositories, please talk to Rich. You will need to increase your version number at each change (typically each merge into main/master) for the installation to notice that you have made changes.</p>
</div>
<div id="install-packages-directly-from-github-or-similar" class="section level2">
<h2 class="hasAnchor">
<a href="#install-packages-directly-from-github-or-similar" class="anchor"></a>Install packages directly from GitHub (or similar)</h2>
<p>We use <a href="https://r-lib.github.io/pkgdepends/"><code>pkgdepends</code></a> as the engine for installing packages from exotic locations. This is a problem that is slightly more complicated than it seems because the resolution of the dependencies are not always unambiguous, particularly with networks of dependent packages.</p>
<p>The basic idea is this. Suppose we want to install the <a href="https://github.com/richfitz/rfiglet"><code>rfiglet</code></a> package, which is not on CRAN. We use the “Remotes”-style reference <code>richfitz/rfiglet</code> as an entry to <code>conan_sources</code> so that <code>didehpc</code> knows where to install <code>rfiglet</code> from:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">src</span> <span class="op">&lt;-</span> <span class="fu">conan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/conan/man/conan_sources.html">conan_sources</a></span><span class="op">(</span><span class="st">"richfitz/rfiglet"</span><span class="op">)</span>
<span class="va">ctx</span> <span class="op">&lt;-</span> <span class="fu">context</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/context/man/context_save.html">context_save</a></span><span class="op">(</span><span class="va">root</span>, packages <span class="op">=</span> <span class="st">"rfiglet"</span>, package_sources <span class="op">=</span> <span class="va">src</span><span class="op">)</span>
<span class="co">#&gt; [ open:db   ]  rds</span>
<span class="co">#&gt; [ save:id   ]  64b4b09d2a42166d9c814f8b6f3bd0c0</span>
<span class="co">#&gt; [ save:name ]  juvenal_roebuck</span></code></pre></div>
<p>Note that we still list <code>rfiglet</code> within the <code>packages</code> section of <code><a href="https://rdrr.io/pkg/context/man/context_save.html">context::context_save</a></code> as that is what is used to load the package.</p>
<p>If you want to be even more explicit you can use <code>github::richfitz/rfiglet</code> as the reference, and you can add references such as <code>richfitz/rfiglet@d713c1b8</code> to point at a particular commit, branch or tag.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">didehpc</span><span class="fu">::</span><span class="fu"><a href="../reference/queue_didehpc.html">queue_didehpc</a></span><span class="op">(</span><span class="va">ctx</span><span class="op">)</span>
<span class="co">#&gt; Loading context 64b4b09d2a42166d9c814f8b6f3bd0c0</span>
<span class="co">#&gt; [ context   ]  64b4b09d2a42166d9c814f8b6f3bd0c0</span>
<span class="co">#&gt; [ library   ]  rfiglet</span>
<span class="co">#&gt; [ namespace ]</span>
<span class="co">#&gt; [ source    ]</span>
<span class="co">#&gt; Running installation script on cluster</span>
<span class="co">#&gt;   ,:\      /:.</span>
<span class="co">#&gt;  //  \_()_/  \\</span>
<span class="co">#&gt; ||   |    |   ||  CONAN THE LIBRARIAN</span>
<span class="co">#&gt; ||   |    |   ||  Library:   Q:\didehpc\20210420-102851\pkgs\lib\windows\4.0</span>
<span class="co">#&gt; ||   |____|   ||  Bootstrap: T:\conan\bootstrap\4.0</span>
<span class="co">#&gt;  \\  / || \  //   Cache:     Q:\didehpc\20210420-102851\pkgs\conan\cache/pkg</span>
<span class="co">#&gt;   `:/  ||  \;'    Policy:    lazy</span>
<span class="co">#&gt;        ||         Repos:</span>
<span class="co">#&gt;        ||           * https://cloud.r-project.org</span>
<span class="co">#&gt;        XX           * https://mrc-ide.github.io/didehpc-pkgs</span>
<span class="co">#&gt;        XX         Packages:</span>
<span class="co">#&gt;        XX           * context</span>
<span class="co">#&gt;        XX           * rfiglet</span>
<span class="co">#&gt;        OO           * richfitz/rfiglet</span>
<span class="co">#&gt;        `'</span>
<span class="co">#&gt; i Loading metadata database</span>
<span class="co">#&gt; v Loading metadata database ... done</span>
<span class="co">#&gt;</span>
<span class="co">#&gt; ! Using bundled GitHub PAT. Please add your own PAT using `gitcreds::gitcreds_set()`.</span>
<span class="co">#&gt; i No downloads are needed, 1 pkg is cached</span>
<span class="co">#&gt; v Got rfiglet 0.2.0 (source) (144.05 kB)</span>
<span class="co">#&gt; i Packaging rfiglet 0.2.0</span>
<span class="co">#&gt; v Packaged rfiglet 0.2.0 (3.9s)</span>
<span class="co">#&gt; i Building rfiglet 0.2.0</span>
<span class="co">#&gt; v Built rfiglet 0.2.0 (2.9s)</span>
<span class="co">#&gt; v Installed rfiglet 0.2.0 (github::richfitz/rfiglet@d713c1b) (594ms)</span>
<span class="co">#&gt; v Summary:   1 new   10 kept  in 3.5s</span>
<span class="co">#&gt; Done!</span></code></pre></div>
</div>
<div id="install-private-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#install-private-packages" class="anchor"></a>Install private packages</h2>
<p>To install a private package, first make a local copy of the package somewhere on your system. Then you need to build a <em>source</em> copy of this package (this will have a file extension of <code>tar.gz</code>).</p>
<p>For example, suppose that the path <code>~/Documents/src/defer</code> contains a copy of your sources that you want to install, you could write:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>path &lt;-<span class="st"> </span>pkgbuild<span class="op">::</span><span class="kw">build</span>(<span class="st">"~/Documents/src/defer"</span>, <span class="st">"."</span>)</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co">#&gt;   </span></span>
<span id="cb7-3"><a href="#cb7-3"></a>   checking <span class="cf">for</span> file ‘<span class="op">/</span>home<span class="op">/</span>rich<span class="op">/</span>Documents<span class="op">/</span>src<span class="op">/</span>defer<span class="op">/</span>DESCRIPTION’ ...</span>
<span id="cb7-4"><a href="#cb7-4"></a>  </span>
<span id="cb7-5"><a href="#cb7-5"></a>✔  checking <span class="cf">for</span> file ‘<span class="op">/</span>home<span class="op">/</span>rich<span class="op">/</span>Documents<span class="op">/</span>src<span class="op">/</span>defer<span class="op">/</span>DESCRIPTION’</span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co">#&gt; </span></span>
<span id="cb7-7"><a href="#cb7-7"></a>  </span>
<span id="cb7-8"><a href="#cb7-8"></a>─  preparing ‘defer’<span class="op">:</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co">#&gt; </span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="st">  </span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="st">   </span>checking DESCRIPTION meta<span class="op">-</span>information ...</span>
<span id="cb7-12"><a href="#cb7-12"></a>  </span>
<span id="cb7-13"><a href="#cb7-13"></a>✔  checking DESCRIPTION meta<span class="op">-</span>information</span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="co">#&gt; </span></span>
<span id="cb7-15"><a href="#cb7-15"></a>  </span>
<span id="cb7-16"><a href="#cb7-16"></a>─  checking <span class="cf">for</span> LF line<span class="op">-</span>endings <span class="cf">in</span> source and make files and shell scripts</span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="co">#&gt; </span></span>
<span id="cb7-18"><a href="#cb7-18"></a>  </span>
<span id="cb7-19"><a href="#cb7-19"></a>─  checking <span class="cf">for</span> empty or unneeded directories</span>
<span id="cb7-20"><a href="#cb7-20"></a><span class="co">#&gt; ─  building ‘defer_0.1.0.tar.gz’</span></span>
<span id="cb7-21"><a href="#cb7-21"></a><span class="co">#&gt;</span></span>
<span id="cb7-22"><a href="#cb7-22"></a><span class="co">#&gt;</span></span></code></pre></div>
<p>The second argument (<code>.</code>) is the directory that the built package will be created in. This must be in your working directory. You might find using something like <code>pkgs</code> as a destination helps keeps things tidy. (You may want to use the <code>vignettes = FALSE</code> argument to speed this process up if your package includes slow-to-run vignettes as they will be of no use on the cluster).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/file.info.html">file.info</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span>
<span class="co">#&gt;                      size isdir mode               mtime               ctime</span>
<span class="co">#&gt; ./defer_0.1.0.tar.gz 3810 FALSE  755 2021-04-20 10:31:56 2021-04-20 10:31:56</span>
<span class="co">#&gt;                                    atime  uid  gid uname grname</span>
<span class="co">#&gt; ./defer_0.1.0.tar.gz 2021-04-20 10:31:56 1000 1000  rich   rich</span></code></pre></div>
<p>Then construct your package sources passing in the <strong>relative</strong> path to your package. We can use the <code>path</code> variable here, or you could write ./defer_0.1.0.tar.gz directly, or something like local::defer_0.1.0.tar.gz. If you have multiple packages you can pass a vector in.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">src</span> <span class="op">&lt;-</span> <span class="fu">conan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/conan/man/conan_sources.html">conan_sources</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span>
<span class="va">ctx</span> <span class="op">&lt;-</span> <span class="fu">context</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/context/man/context_save.html">context_save</a></span><span class="op">(</span><span class="va">root</span>, packages <span class="op">=</span> <span class="st">"defer"</span>, package_sources <span class="op">=</span> <span class="va">src</span><span class="op">)</span>
<span class="co">#&gt; [ open:db   ]  rds</span>
<span class="co">#&gt; [ save:id   ]  67a2219cc6503939eb8667192e42ba45</span>
<span class="co">#&gt; [ save:name ]  evolutional_erne</span></code></pre></div>
<p>when you construct the context, this package will be installed for you</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">didehpc</span><span class="fu">::</span><span class="fu"><a href="../reference/queue_didehpc.html">queue_didehpc</a></span><span class="op">(</span><span class="va">ctx</span><span class="op">)</span>
<span class="co">#&gt; Loading context 67a2219cc6503939eb8667192e42ba45</span>
<span class="co">#&gt; [ context   ]  67a2219cc6503939eb8667192e42ba45</span>
<span class="co">#&gt; [ library   ]  defer</span>
<span class="co">#&gt; [ namespace ]</span>
<span class="co">#&gt; [ source    ]</span>
<span class="co">#&gt; Running installation script on cluster</span>
<span class="co">#&gt;   ,:\      /:.</span>
<span class="co">#&gt;  //  \_()_/  \\</span>
<span class="co">#&gt; ||   |    |   ||  CONAN THE LIBRARIAN</span>
<span class="co">#&gt; ||   |    |   ||  Library:   Q:\didehpc\20210420-102851\pkgs\lib\windows\4.0</span>
<span class="co">#&gt; ||   |____|   ||  Bootstrap: T:\conan\bootstrap\4.0</span>
<span class="co">#&gt;  \\  / || \  //   Cache:     Q:\didehpc\20210420-102851\pkgs\conan\cache/pkg</span>
<span class="co">#&gt;   `:/  ||  \;'    Policy:    lazy</span>
<span class="co">#&gt;        ||         Repos:</span>
<span class="co">#&gt;        ||           * https://cloud.r-project.org</span>
<span class="co">#&gt;        XX           * https://mrc-ide.github.io/didehpc-pkgs</span>
<span class="co">#&gt;        XX         Packages:</span>
<span class="co">#&gt;        XX           * context</span>
<span class="co">#&gt;        XX           * defer</span>
<span class="co">#&gt;        OO           * local::./defer_0.1.0.tar.gz</span>
<span class="co">#&gt;        `'</span>
<span class="co">#&gt; i Loading metadata database</span>
<span class="co">#&gt; v Loading metadata database ... done</span>
<span class="co">#&gt; i No downloads are needed, 1 pkg is cached</span>
<span class="co">#&gt; v Got defer 0.1.0 (source) (3.81 kB)</span>
<span class="co">#&gt; i Building defer 0.1.0</span>
<span class="co">#&gt; v Built defer 0.1.0 (2s)</span>
<span class="co">#&gt; v Installed defer 0.1.0 (local) (422ms)</span>
<span class="co">#&gt; v Summary:   1 new   10 kept  in 2.4s</span>
<span class="co">#&gt; Done!</span></code></pre></div>
</div>
<div id="troubleshooting-package-installation" class="section level2">
<h2 class="hasAnchor">
<a href="#troubleshooting-package-installation" class="anchor"></a>Troubleshooting package installation</h2>
<div id="local-copies" class="section level3">
<h3 class="hasAnchor">
<a href="#local-copies" class="anchor"></a>Local copies</h3>
<p>You must have local copies of all packages installed (i.e., on the machine that is submitting the jobs). This is because we use some information about the packages to work out what can be run on the cluster. If you see a message like this when creating the queue object:</p>
<pre><code>Loading context d1b3973bef7762b8d4d4ff5cbe090b2c
[ context   ]  d1b3973bef7762b8d4d4ff5cbe090b2c
[ library   ]  rfiglet
Error in library(p, character.only = TRUE) :
  there is no package called ‘rfiglet’</code></pre>
<p>it means that you do not have the package installed <em>locally</em> and you should install it before continuing.</p>
</div>
<div id="file-locking" class="section level3">
<h3 class="hasAnchor">
<a href="#file-locking" class="anchor"></a>File locking</h3>
<p>You cannot upgrade packages while you have cluster jobs running. The reason for this is <a href="https://en.wikipedia.org/wiki/File_locking">file locking</a>; any cluster job running has a copy of the package loaded and will prevent deletion. Unfortunately the installation will delete quite a lot of the package before it realises that it is locked, which causes all sorts of problems.</p>
<p>Typically if you hit this you will see a “permission denied” error concerning a dll. Once this has happened you should be prepared for any queued jobs to fail.</p>
<p>To avoid, if upgrading packages, use a new context root.</p>
</div>
</div>
<div id="more-control-over-the-process" class="section level2">
<h2 class="hasAnchor">
<a href="#more-control-over-the-process" class="anchor"></a>More control over the process</h2>
<p>The package installation may seem a bit magic but you can tame it a little.</p>
<p>When constructing your queue object, you can control how provisioning will occur with the <code>provision</code> argument. The default is to check to see if any packages listed in your context’s <code>packages</code> argument are missing and only then do installation.</p>
<p>If you pass <code>provision = "fake"</code> it will leave your library alone no matter what. Alternatively pass <code>provision = "upgrade"</code> to try and upgrade packages, or <code>provision = "later"</code> to skip this step for now. You can’t submit jobs while your package installation looks incomplete.</p>
<p>If you want to add additional things into the library without running the full provisioning (which might upgrade all sorts of things) you can use the <code>install_packages()</code> method on the object. This ignores the contents of your <code>conan_sources</code> and you pass directly in the <code>pkgdepends</code>-style references; see <a href="https://r-lib.github.io/pkgdepends/reference/pkg_refs.html">the <code>pkgdepends</code> documentation</a> for the myriad options here. Examples of usage include:</p>
<p>Install the latest version of a CRAN package</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">obj</span><span class="op">$</span><span class="fu">install_packages</span><span class="op">(</span><span class="st">"data.table"</span><span class="op">)</span></code></pre></div>
<p>Install a GitHub package</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">obj</span><span class="op">$</span><span class="fu">install_packages</span><span class="op">(</span><span class="st">"richfitz/stegasaur"</span><span class="op">)</span></code></pre></div>
<p>Install some local package from a <code>.tar.gz</code> file</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">obj</span><span class="op">$</span><span class="fu">install_packages</span><span class="op">(</span><span class="st">"local::mypkg_0.1.2.tar.gz"</span><span class="op">)</span></code></pre></div>
<p>You can possibly use this interface (along with <code>provision = "fake"</code>) to manipulate your package installation fairly flexibly.</p>
</div>
<div id="installation-failure-the-wrong-versions-have-been-selected" class="section level2">
<h2 class="hasAnchor">
<a href="#installation-failure-the-wrong-versions-have-been-selected" class="anchor"></a>Installation failure / the wrong versions have been selected</h2>
<p>It is possible to end up in a situation where <code>pkgdepends</code> can’t resolve your dependencies, or where in resolving dependencies an unwanted version of a package was installed. Please let Rich know with enough detail for him to reproduce the example himself:</p>
<ul>
<li>A copy of the code that runs up to <code><a href="../reference/queue_didehpc.html">didehpc::queue_didehpc(...)</a></code> covering things like <code><a href="https://rdrr.io/pkg/context/man/context_save.html">context::context_save()</a></code> and <code><a href="https://rdrr.io/pkg/conan/man/conan_sources.html">conan::conan_sources()</a></code>
</li>
<li>Copies of any manually built <code>.tar.gz</code> files that you are using</li>
<li>A full copy of the log</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Rich FitzJohn, Wes Hinsley.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
