---
title: "Using didehpc to run orderly tasks"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Using didehpc to run orderly tasks}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- HEADER -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  error = FALSE,
  comment = "#>"
)
orderly_root <- orderly:::prepare_orderly_example("demo")
```

When using [orderly](https://github.com/vimc/orderly) some tasks might be slow to run and would be better suited to running on a remote machine. You can use the cluster and [orderly bundles](https://www.vaccineimpact.org/orderly/articles/bundles.html) to achieve this. If your orderly instance has an [OrderlyWeb](https://github.com/vimc/orderly-web) remote then you should favour running tasks on the configured remote via `orderly::orderly_run_remote` (unless it is too slow even for the OrderlyWeb remote). If your orderly instance is using a [sharepoint remote](https://github.com/vimc/orderly.sharepoint) or has no remote then you can use the cluster to run your slow running tasks.

## Running a task on the cluster

To run a single task or report on the cluster start by creating a directory that we will store bundles on that is within the network drive. There is no need for your orderly archive to be on a network path, and it may be preferable to store it somewhere not on a network drive to keep things tidy. For example on Linux, we might write:

```{r}
root <- "~/net/home/contexts"
path_bundles <- file.path(root, "bundles")

## Create bundle
bundle <- orderly::orderly_bundle_pack(path_bundles, 
                                       "minimal", 
                                       root = orderly_root)
```

Then setup the cluster with required packages, you will need `orderly` at a minimum. You can use the list of packages from the `orderly.yml` e.g. for report `internal-2017-population-TUV-MHL`

```{r}
orderly_packages <- yaml::read_yaml(
  file.path(orderly_root, "src/minimal/orderly.yml"))$packages
packages <- list(loaded = c("orderly", orderly_packages))
config <- didehpc::didehpc_config(workdir = root)
ctx <- context::context_save(root, packages = packages)
obj <- didehpc::queue_didehpc(ctx, config = config)
```

The orderly task can then be run via `orderly::orderly_bundle_run`, being careful to make sure the paths are relative to the `workdir` passed in `didehpc_config`

```{r}
path <- file.path("bundles", basename(bundle$path))
output_path <- "output"
t <- obj$enqueue(orderly::orderly_bundle_run(path, output_path))
```

When the job has completed you can import the returned bundle. If you are on windows then the `path` in the result should just work. If you are on Mac or Linux you will need to construct the path

```{r}
output <- strsplit(t$wait(100)$path, "\\\\")[[1]]
output_filename <- output[length(output)]
orderly::orderly_bundle_import(file.path(root, output_path, output_filename),
                               root = orderly_root)
```
And you can see that the report has been run and imported into the orderly archive

```{r}
orderly::orderly_list_archive(root = orderly_root)
```
`orderly::orderly_bundle_pack` can pack reports for running on the cluster which take `parameters`, `instance` and `remote` args like `orderly_run`. There are also remote equivalents which will can be used to pack a bundle on the remote instance, see [`orderly::orderly_bundle_pack_remote`](https://www.vaccineimpact.org/orderly/reference/orderly_bundle_pack_remote.html) for details.

## Bundle multiple reports or one report with multiple sets of parameters

A bundle can only contain 1 orderly task for running. If you want to run multiple reports on the cluster or one report with multiple sets of parameters you need to create multiple bundles. You can make this easier with a script e.g.

```{r}
params <- c(0.25, 0.5, 0.75)
bundles <- lapply(params, function(nmin) {
  orderly::orderly_bundle_pack(path_bundles, "other", 
                               parameters = list(nmin = nmin), 
                               root = orderly_root)
  })
paths <- vapply(bundles, function(bundle) {
    file.path("bundles", basename(bundle$path))
  }, character(1))
```

and queue the tasks with `lapply`
```{r}
t <- obj$lapply(paths, orderly::orderly_bundle_run, output_path)
```
import the results
```{r}
for (output in t$wait(100)) {
  out <- strsplit(output$path, "\\\\")[[1]]
  output_filename <- out[length(out)]
  orderly::orderly_bundle_import(file.path(root, output_path, output_filename),
                               root = orderly_root)
}
```
```{r}
orderly::orderly_list_archive(root = orderly_root)
```
