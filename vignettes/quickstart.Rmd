---
title: "Quickstart for R and the DIDE cluster"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Quickstart for R and the DIDE cluster}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- DO NOT EDIT THIS FILE - see vignettes_src and make changes there -->



> Get yourself running R jobs on the cluster in 10 minutes or so.

Assumptions that we make here:

* you are using R

* your task can be represented as running a function on some inputs
  to create an output (a file based output is OK)

* you are working on a network share and have this mounted on your
  computer

* you know what packages your code depends on

* your package dependencies are all on CRAN, and are all available
  in windows binary form.

If any of these do not apply to you, you'll probably need to read
the full vignette.  In any case the full vignette contains a bunch
more information anyway.

## Install a lot of packages

Install the packages using [`drat`](https://cran.rstudio.com/package=drat)

```r
# install.package("drat") # if you don't have it already
drat:::add("mrc-ide")
install.packages("didehpc")
```

## Describe your computer so we can find things

On windows if you are using a domain machine, you should need only
to select the cluster you want to use

```r
options(didehpc.cluster = "fi--didemrchnb")
```

Otherwise, and on any other platform you'll need to provide your username:

```r
options(didehpc.cluster = "fi--didemrchnb",
        didehpc.username = "yourusername")
```

You can see the default configuration with


```r
didehpc::didehpc_config()
#> <didehpc_config>
#>  - cluster: fi--dideclusthn
#>  - credentials:
#>     - username: rfitzjoh
#>     - password: *******************
#>  - username: rfitzjoh
#>  - template: GeneralNodes
#>  - resource:
#>     - parallel: FALSE
#>     - count: 1
#>     - type: Cores
#>  - shares:
#>     - home: (local) /home/rich/net/home => \\fi--san03.dide.ic.ac.uk\homes\rfitzjoh => Q: (remote)
#>     - temp: (local) /home/rich/net/temp => \\fi--didef3.dide.ic.ac.uk\tmp => T: (remote)
#>  - use_workers: FALSE
#>  - use_rrq: FALSE
#>  - worker_timeout: 600
#>  - conan_bootstrap: TRUE
#>  - r_version: 4.0.3
#>  - use_java: FALSE
#>  - redis_host: fi--dideclusthn.dide.ic.ac.uk
```

If this is the first time you have run this package, best to try
out the login procedure with:


```r
didehpc::web_login()
```

because this exposes a number of problems early on.

## Describe your project dependencies so we can recreate that on the cluster

Make a vector of packages that you use in your project:


```r
packages <- c("dplyr", "tidyr")
```

And of files that define functions that you ned to run things:


```r
sources <- "mysources.R"
```

If you had a vector here that would be OK too.

Then save this together to form a "context".


```r
ctx <- context::context_save("contexts", packages = packages, sources = sources)
#> [ open:db   ]  rds
#> [ save:id   ]  9c28bcc906fdf1b72cd59948d3b3e218
#> [ save:name ]  low_banteng
```

If you have no packages or no sources, use `NULL` or omit them in
the call below (which is the default anyway).

The first argument here, `"contexts"` is the name of a directory
that we will use to hold a lot of information about your jobs.  You
don't need (or particularly want) to know what is in here.

## Build a queue, based on this context.

This will prompt you for your password, as it will try and log in.

It also installs windows versions of all packages within the
`contexts` directory -- both packages required to get this whole
system working and then the packages required for your particular
jobs.



```r
obj <- didehpc::queue_didehpc(ctx)
#> Loading context 9c28bcc906fdf1b72cd59948d3b3e218
#> [ context   ]  9c28bcc906fdf1b72cd59948d3b3e218
#> [ library   ]  dplyr, tidyr
#>
#> Attaching package: 'dplyr'
#> The following objects are masked from 'package:stats':
#>
#>     filter, lag
#> The following objects are masked from 'package:base':
#>
#>     intersect, setdiff, setequal, union
#> [ namespace ]
#> [ source    ]  mysources.R
#> Running installation script on cluster
#> [-]  0s ...[\]  0s RUNNING[|]  1s RUNNING                                                                              CONAN THE LIBRARIAN I: the bootstrappening
#> Installing bootstrap library into 'T:\conan\bootstrap\4.0'
#> Success!
#> CONAN THE LIBRARIAN
#> Library:   Q:\didehpc\20210408-182648\contexts\lib\windows\4.0
#> Bootstrap: T:\conan\bootstrap\4.0
#> Cache:     Q:\didehpc\20210408-182648\contexts\conan\cache/pkg
#> Policy:    lazy
#> Repos:
#>  * https://mrc-ide.github.io/didehpc-pkgs
#>  * https://cloud.r-project.org
#> Packages:
#>  * context
#>  * dplyr
#>  * tidyr
#> [/]  2s RUNNING                                                                              i Loading metadata database
#> [-]  3s RUNNING[\]  4s RUNNING                                                                              v Loading metadata database ... done
#>
#> [|]  5s RUNNING                                                                              i Getting 18 pkgs (9.34 MB)
#> [/]  6s RUNNING                                                                              v Got ellipsis 0.3.1 (windows) (46.12 kB)
#> [-]  7s RUNNING[\]  8s RUNNING                                                                              v Got generics 0.1.0 (windows) (71.29 kB)
#> v Got cli 2.3.1 (windows) (474.17 kB)
#> v Got assertthat 0.2.1 (windows) (55.09 kB)
#> v Got glue 1.4.2 (windows) (155.51 kB)
#> [|] 10s RUNNING                                                                              v Got magrittr 2.0.1 (windows) (235.61 kB)
#> v Got lifecycle 1.0.0 (windows) (111.19 kB)
#> v Got fansi 0.4.2 (windows) (224.26 kB)
#> v Got pkgconfig 2.0.3 (windows) (22.34 kB)
#> v Got dplyr 1.0.5 (windows) (1.34 MB)
#> v Got purrr 0.3.4 (windows) (430.05 kB)
#> v Got tidyselect 1.1.0 (windows) (203.20 kB)
#> v Got utf8 1.2.1 (windows) (209.89 kB)
#> v Got pillar 1.5.1 (windows) (962.07 kB)
#> [/] 10s RUNNING                                                                              v Got tibble 3.1.0 (windows) (825.66 kB)
#> v Got vctrs 0.3.7 (windows) (1.25 MB)
#> v Got rlang 0.4.10 (windows) (1.20 MB)
#> v Got tidyr 1.1.3 (windows) (1.06 MB)
#> [-] 11s RUNNING                                                                              v Installed assertthat 0.2.1  (1.3s)
#> v Installed generics 0.1.0  (1.2s)
#> v Installed ellipsis 0.3.1  (1.5s)
#> [\] 13s RUNNING                                                                              v Installed fansi 0.4.2  (1.7s)
#> v Installed cli 2.3.1  (2s)
#> v Installed pkgconfig 2.0.3  (1.8s)
#> [|] 13s RUNNING                                                                              v Installed glue 1.4.2  (2.4s)
#> v Installed lifecycle 1.0.0  (2.5s)
#> v Installed purrr 0.3.4  (2.4s)
#> v Installed pillar 1.5.1  (2.7s)
#> v Installed magrittr 2.0.1  (2.9s)
#> v Installed dplyr 1.0.5  (3.3s)
#> [/] 14s RUNNING                                                                              v Installed rlang 0.4.10  (2s)
#> v Installed tidyselect 1.1.0  (1.8s)
#> v Installed tibble 3.1.0  (2.2s)
#> v Installed utf8 1.2.1  (1.8s)
#> v Installed vctrs 0.3.7  (2s)
#> v Installed tidyr 1.1.3  (1.9s)
#> v Summary:   18 new   10 kept  in 37.2s
#> [-] 15s RUNNING                                                                              Done!
```

Once you get to this point we're ready to start running things on
the cluster.  Let's fire off a test to make sure that everything works OK:


```r
t <- obj$enqueue(sessionInfo())
```

We can poll the job for a while, which will print a progress bar.
If the job is returned in time, it will return the result of
running the function.  Otherwise it will throw an error.


```r
t$wait(120)
#> (-) waiting for 8d34dcb...4d2, giving up in 119.5 s (\) waiting for 8d34dcb...
#> 4d2, giving up in 119.0 s (|) waiting for 8d34dcb...4d2, giving up in 118.4 s
#> (/) waiting for 8d34dcb...4d2, giving up in 117.9 s
#> R version 4.0.3 (2020-10-10)
#> Platform: x86_64-w64-mingw32/x64 (64-bit)
#> Running under: Windows Server 2012 R2 x64 (build 9600)
#>
#> Matrix products: default
#>
#> locale:
#> [1] LC_COLLATE=English_United Kingdom.1252
#> [2] LC_CTYPE=English_United Kingdom.1252
#> [3] LC_MONETARY=English_United Kingdom.1252
#> [4] LC_NUMERIC=C
#> [5] LC_TIME=English_United Kingdom.1252
#>
#> attached base packages:
#> [1] stats     graphics  grDevices utils     datasets  methods   base
#>
#> other attached packages:
#> [1] dplyr_1.0.5 tidyr_1.1.3
#>
#> loaded via a namespace (and not attached):
#>  [1] fansi_0.4.2      crayon_1.4.1     digest_0.6.27    utf8_1.2.1
#>  [5] context_0.3.0    R6_2.5.0         lifecycle_1.0.0  storr_1.2.5
#>  [9] magrittr_2.0.1   pillar_1.5.1     rlang_0.4.10     vctrs_0.3.7
#> [13] generics_0.1.0   ellipsis_0.3.1   glue_1.4.2       purrr_0.3.4
#> [17] compiler_4.0.3   pkgconfig_2.0.3  tidyselect_1.1.0 tibble_3.1.0
```

You can use `t$result()` to get the result straight away (throwing
an error if it is not ready) or `t$wait(Inf)` to wait forever.


```r
t$result()
#> R version 4.0.3 (2020-10-10)
#> Platform: x86_64-w64-mingw32/x64 (64-bit)
#> Running under: Windows Server 2012 R2 x64 (build 9600)
#>
#> Matrix products: default
#>
#> locale:
#> [1] LC_COLLATE=English_United Kingdom.1252
#> [2] LC_CTYPE=English_United Kingdom.1252
#> [3] LC_MONETARY=English_United Kingdom.1252
#> [4] LC_NUMERIC=C
#> [5] LC_TIME=English_United Kingdom.1252
#>
#> attached base packages:
#> [1] stats     graphics  grDevices utils     datasets  methods   base
#>
#> other attached packages:
#> [1] dplyr_1.0.5 tidyr_1.1.3
#>
#> loaded via a namespace (and not attached):
#>  [1] fansi_0.4.2      crayon_1.4.1     digest_0.6.27    utf8_1.2.1
#>  [5] context_0.3.0    R6_2.5.0         lifecycle_1.0.0  storr_1.2.5
#>  [9] magrittr_2.0.1   pillar_1.5.1     rlang_0.4.10     vctrs_0.3.7
#> [13] generics_0.1.0   ellipsis_0.3.1   glue_1.4.2       purrr_0.3.4
#> [17] compiler_4.0.3   pkgconfig_2.0.3  tidyselect_1.1.0 tibble_3.1.0
```

## Running a single task

This is just using the `enqueue` function as above.  But it also
works with functions defined in files passed in as `sources`; here
the function `random_walk`.


```r
t <- obj$enqueue(random_walk(0, 10))
res <- t$wait(120)
#> (-) waiting for f4eccff...2d1, giving up in 119.5 s (\) waiting for f4eccff...
#> 2d1, giving up in 119.0 s (|) waiting for f4eccff...2d1, giving up in 118.5 s
#> (/) waiting for f4eccff...2d1, giving up in 118.0 s
res
#>  [1] -1.4475316 -0.5546022 -0.9779921 -1.2631108 -2.3218169 -2.1198780
#>  [7] -0.6472786 -0.7765402  0.0661252 -0.5892064
```

The `t` object has a number of other methods you can use:


```r
t
#> <queuer_task>
#>   Public:
#>     clone: function (deep = FALSE)
#>     context_id: function ()
#>     expr: function (locals = FALSE)
#>     id: f4eccffea20e98f01a9b4b94ac43f2d1
#>     initialize: function (id, root, check_exists = TRUE)
#>     log: function (parse = TRUE)
#>     result: function (allow_incomplete = FALSE)
#>     root: context_root
#>     status: function ()
#>     times: function (unit_elapsed = "secs")
#>     wait: function (timeout, time_poll = 0.5, progress = NULL)
```

Get the result from running a task


```r
t$result()
#>  [1] -1.4475316 -0.5546022 -0.9779921 -1.2631108 -2.3218169 -2.1198780
#>  [7] -0.6472786 -0.7765402  0.0661252 -0.5892064
```

Get the status of the task


```r
t$status()
#> [1] "COMPLETE"
```

(might also be "PENDING", "RUNNING" or "ERROR"

Get the original expression:


```r
t$expr()
#> random_walk(0, 10)
```

Find out how long everything took


```r
t$times()
#>                            task_id           submitted             started
#> 1 f4eccffea20e98f01a9b4b94ac43f2d1 2021-04-08 18:27:50 2021-04-08 18:27:52
#>              finished  waiting    running      idle
#> 1 2021-04-08 18:27:52 2.219392 0.03125095 0.3694475
```

You may see negative numbers for "waiting" as the submitted time is
based on your computer and started/finished are based on the
cluster.

And get the log from running the task


```r
t$log()
#> [ hello     ]  2021-04-08 18:27:51
#> [ wd        ]  Q:/didehpc/20210408-182648
#> [ init      ]  2021-04-08 18:27:51.671
#> [ hostname  ]  FI--DIDECLUST25
#> [ process   ]  4972
#> [ version   ]  0.3.0
#> [ open:db   ]  rds
#> [ context   ]  9c28bcc906fdf1b72cd59948d3b3e218
#> [ library   ]  dplyr, tidyr
#>
#>     Attaching package: 'dplyr'
#>
#>     The following objects are masked from 'package:stats':
#>
#>         filter, lag
#>
#>     The following objects are masked from 'package:base':
#>
#>         intersect, setdiff, setequal, union
#>
#> [ namespace ]
#> [ source    ]  mysources.R
#> [ parallel  ]  running as single core job
#> [ root      ]  Q:\didehpc\20210408-182648\contexts
#> [ context   ]  9c28bcc906fdf1b72cd59948d3b3e218
#> [ task      ]  f4eccffea20e98f01a9b4b94ac43f2d1
#> [ expr      ]  random_walk(0, 10)
#> [ start     ]  2021-04-08 18:27:52.859
#> [ ok        ]
#> [ end       ]  2021-04-08 18:27:52.937
#>     Warning messages:
#>     1: package 'tidyr' was built under R version 4.0.5
#>     2: package 'dplyr' was built under R version 4.0.5
```

There is also a bit of DIDE specific logging that happens before
this point; if the job fails inexplicably the answer may be in:


```r
obj$dide_log(t)
#>  [1] "generated on host: kea"
#>  [2] "generated on date: 2021-04-08"
#>  [3] "didehpc version: 0.3.0"
#>  [4] "context version: 0.3.0"
#>  [5] "running on: FI--DIDECLUST25"
#>  [6] "mapping Q: -> \\\\fi--san03.dide.ic.ac.uk\\homes\\rfitzjoh"
#>  [7] "The command completed successfully."
#>  [8] ""
#>  [9] "mapping T: -> \\\\fi--didef3.dide.ic.ac.uk\\tmp"
#> [10] "The command completed successfully."
#> [11] ""
#> [12] "Using Rtools at T:\\Rtools\\Rtools40"
#> [13] "working directory: Q:\\didehpc\\20210408-182648"
#> [14] "this is a single task"
#> [15] "logfile: Q:\\didehpc\\20210408-182648\\contexts\\logs\\f4eccffea20e98f01a9b4b94ac43f2d1"
#> [16] ""
#> [17] "Q:\\didehpc\\20210408-182648>Rscript \"Q:\\didehpc\\20210408-182648\\contexts\\bin\\task_run\" \"Q:\\didehpc\\20210408-182648\\contexts\" f4eccffea20e98f01a9b4b94ac43f2d1  1>\"Q:\\didehpc\\20210408-182648\\contexts\\logs\\f4eccffea20e98f01a9b4b94ac43f2d1\" 2>&1"
#> [18] "Removing mapping Q:"
#> [19] "There are open files and/or incomplete directory searches pending on the connection to Q:."
#> [20] ""
#> [21] "Q: was deleted successfully."
#> [22] ""
#> [23] "Removing mapping T:"
#> [24] "T: was deleted successfully."
#> [25] ""
#> [26] "Quitting"
```

Want more information? See `vignette("didehpc")` for more details.
